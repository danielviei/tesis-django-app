{% extends 'layout.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container w-full mx-auto py-8 px-4">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-2/3">
            <article class="p-4 rounded-md shadow-md bg-gray-200 p-2">
                <div class="flex items-center mb-2">
                    <img src="{{ publication.author_id.img.url }}" alt="{{ publication.author_id.email }} profile picture" class="w-10 h-10 rounded-full mr-4">
                    <div class="w-full">
                        <div class="flex justify-between">
                            <h4 class="text-md font-bold text-gray-800">{{ publication.author_id.email }}</h4>
                            {% if publication.author_id == user %}
                            <div>
                                <a href="{% url 'edit_publication' publication.id %}" class="edit-publication-button">editar</a>
                                <!-- <button class="edit-publication-button" data-publication-id="{{ publication.id }}">editar</button> -->
                                <button id="delete-publication-button" data-publication-id="{{ publication.id }}">Eliminar</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <img src="{{ publication.image.url }}" alt="{{ publication.image.alt_text }}" class="w-full rounded-t-md">
                <div class="p-4">
                    <h2 class="text-lg font-bold text-gray-800">{{ publication.title }}</h2>
                    <p class="text-gray-600">{{ publication.content }}</p>
                </div>
            </article>
        </div>
        <div class="w-full md:w-1/3">
            <div class="bg-white rounded-md shadow-md p-4">
                <h3 class="text-lg font-bold text-gray-800">Comentarios</h3>
                <div id="comments-section">
                    <ul class="list-none space-y-4">
                        {% for comment in publication.comments.all %}
                        <li id="comment-{{ comment.id }}" class="p-4 rounded-md bg-gray-100">
                            <div class="flex items-center">
                                <img src="{{ comment.author_id.img.url }}" alt="{{ comment.author_id.email }} profile picture" class="w-10 h-10 rounded-full mr-4">
                                <div>
                                    <div class="flex justify-between">
                                        <h4 class="text-md font-bold text-gray-800">{{ comment.author_id.email }}</h4>
                                        {% if comment.author_id == user %}
                                        <div>
                                            <button class="edit-button" data-comment-id="{{ comment.id }}">editar</button>
                                            <button class="delete-button" data-comment-id="{{ comment.id }}">eliminar</button>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <p id="comment-{{ comment.id }}-content" class="text-gray-600">{{ comment.content }}</p>
                                </div>
                            </div>
                            {% if comment.author_id == user %}
                            <form
                                id="edit-form-{{ comment.id }}"
                                class="edit-form p-2"
                                data-comment-id="{{ comment.id }}"
                                style="display: none;"
                            >
                                <textarea>{{ comment.content }}</textarea>
                                <button type="submit">Guardar</button>
                            </form>
                            <div id="delete-confirmation-{{ comment.id }}" class="delete-confirmation" style="display: none;">
                                <p>¿Estás seguro de que quieres eliminar este comentario?</p>
                                <button class="delete-confirmation-button" data-comment-id="{{ comment.id }}">Eliminar</button>
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <form id="comment-form">
                    {% csrf_token %}
                    <div class="flex flex-col mt-4">
                        <label for="comment_content" class="text-sm font-bold text-gray-800 mb-2">Deja un comentario</label>
                        <textarea
                            name="comment_content"
                            id="comment_content"
                            rows="4"
                            class="w-full shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            required
                        ></textarea>
                        <button type="submit" class="mt-4 px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-700">Publicar</button>
                    </div>
                </form>
                <input
                    type="hidden"
                    name="publication_id"
                    id="publication_id"
                    value="{{ publication.id }}"
                >
            </div>
        </div>
    </div>
</div>
<div
    id="deleteModal"
    class="fixed z-10 inset-0 overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
    style="display: none;"
>
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Confirmación de eliminación
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                ¿Estás seguro de que quieres eliminar este comentario?
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm" id="confirmDelete">
                    Eliminar
                </button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm" data-bs-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
<div
    id="deletePublicationModal"
    class="fixed z-10 inset-0 overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
    style="display: none;"
>
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Confirmación de eliminación
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                ¿Estás seguro de que quieres eliminar esta publication?
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm" id="confirmPublicationDelete">
                    Eliminar
                </button>
                <button id="cancel-button-publication" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('cancel-button-publication').addEventListener('click', function() {
        const deletePublicationModal = document.getElementById('deletePublicationModal');
        deletePublicationModal.style.display = 'none';
    });
    document.getElementById('delete-publication-button').addEventListener('click', function(event) {
        const publicationID = this.dataset.publicationId;

        // Show delete confirmation
        const deletePublicationModal = document.getElementById('deletePublicationModal');
        deletePublicationModal.style.display = 'block';

        // Set the event listener for the confirm delete button
        document.getElementById('confirmPublicationDelete').addEventListener('click', function() {
            // Send delete request
            fetch(`/publications/${publicationID}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error deleting publication: ${response.statusText}`);
                }

                // Redirect to home
                window.location.href = "/";
            })
            .catch(error => {
                console.error(error);
            });

            // Hide the modal
            deletePublicationModal.style.display = 'none';
        });
    });

    document.getElementById('comment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
      
        const commentContent = document.getElementById('comment_content').value;
        const publicationId = document.getElementById('publication_id').value;

        fetch(`/publications/${publicationId}/add-comment/`, { // Replace with your endpoint if different
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value, // Get CSRF token
          },
          body: JSON.stringify({ content: commentContent }),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error creating comment: ${response.statusText}`); // Handle errors appropriately
          }
          return response.json();
        })
        .then(data => {
          // Update comments section
          const commentsSection = document.getElementById('comments-section');
          commentsSection.innerHTML = data.comments_html; // Replace with your HTML update logic
          document.getElementById('comment_content').value = ''; // Clear comment input
          assignListeners();
        })
        .catch(error => {
          console.error(error); // Display error message to the user (optional)
        });
      });
    function assignListeners() {
        document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
        button.addEventListener('click', function() {
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.style.display = 'none';
        });
    });
    // Add event listeners to edit and delete buttons
    document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', function(event) {
            const commentId = event.target.dataset.commentId;
            const commentContentElement = document.querySelector(`#comment-${commentId}-content`);
            const commentContent = commentContentElement.textContent;

            // Hide comment content
            commentContentElement.style.display = 'none';

            // Show edit form
            const editForm = document.querySelector(`#edit-form-${commentId}`);
            editForm.querySelector('textarea').value = commentContent;
            editForm.style.display = 'block';
        });
    });

    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function(event) {
            const commentId = event.target.dataset.commentId;

            // Show delete confirmation
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.style.display = 'block';

            // Set the event listener for the confirm delete button
            document.getElementById('confirmDelete').addEventListener('click', function() {
                // Send delete request
                fetch(`/comments/${commentId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error deleting comment: ${response.statusText}`);
                    }

                    // Remove comment from DOM
                    document.querySelector(`#comment-${commentId}`).remove();
                })
                .catch(error => {
                    console.error(error);
                });

                // Hide the modal
                deleteModal.style.display = 'none';
            });
        });
    });

    // Add event listeners to edit form submit buttons
    document.querySelectorAll('.edit-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const commentId = event.target.dataset.commentId;
            const commentContent = event.target.querySelector('textarea').value;

            // Send edit request
            fetch(`/comments/${commentId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                },
                body: JSON.stringify({ content: commentContent }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error editing comment: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Update comment content
                const commentContentElement = document.querySelector(`#comment-${commentId}-content`);
                commentContentElement.textContent = data.content;

                // Show comment content
                commentContentElement.style.display = '';

                // Hide edit form
                event.target.style.display = 'none';
            })
            .catch(error => {
                console.error(error);
            });
        });
    });
    
    // Add event listeners to delete confirmation buttons
    document.querySelectorAll('.delete-confirmation-button').forEach(button => {
        button.addEventListener('click', function(event) {
            const commentId = event.target.dataset.commentId;

            // Send delete request
            fetch(`/comments/${commentId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error deleting comment: ${response.statusText}`);
                }

                // Remove comment from DOM
                document.querySelector(`#comment-${commentId}`).remove();
            })
            .catch(error => {
                console.error(error);
            });
        });
    });
}
assignListeners();
</script>
{% endblock %}
