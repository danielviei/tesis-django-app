{% extends 'layout.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container mx-auto py-8">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-2/3">
            <article class="p-4 rounded-md shadow-md bg-white">
                <img src="{{ publication.image.url }}" alt="{{ publication.image.alt_text }}" class="w-full rounded-t-md">
                <div class="p-4">
                    <h2 class="text-lg font-bold text-gray-800">{{ publication.title }}</h2>
                    <p class="text-gray-600">{{ publication.content }}</p>
                </div>
            </article>
        </div>
        <div class="w-full md:w-1/3">
            <div class="bg-white rounded-md shadow-md p-4">
                <h3 class="text-lg font-bold text-gray-800">Comentarios</h3>
                <div id="comments-section">
                    <ul class="list-none space-y-4">
                        {% for comment in publication.comments.all %}
                        <li class="p-4 rounded-md bg-gray-100">
                            <div class="flex items-center">
                                <img src="{{ comment.author_id.img.url }}" alt="{{ comment.author_id.email }} profile picture" class="w-10 h-10 rounded-full mr-4">
                                <div>
                                    <h4 class="text-md font-bold text-gray-800">{{ comment.author_id.email }}</h4>
                                    <p class="text-gray-600">{{ comment.content }}</p>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <form id="comment-form">
                    {% csrf_token %}
                    <div class="flex flex-col mt-4">
                        <label for="comment_content" class="text-sm font-bold text-gray-800 mb-2">Deja un comentario</label>
                        <textarea
                            name="comment_content"
                            id="comment_content"
                            rows="4"
                            class="w-full shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            required
                        ></textarea>
                        <button type="submit" class="mt-4 px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-700">Comentar</button>
                    </div>
                </form>
                <input
                    type="hidden"
                    name="publication_id"
                    id="publication_id"
                    value="{{ publication.id }}"
                >
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('comment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
      
        const commentContent = document.getElementById('comment_content').value;
        const publicationId = document.getElementById('publication_id').value;

        fetch(`/publications/${publicationId}/add-comment/`, { // Replace with your endpoint if different
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value, // Get CSRF token
          },
          body: JSON.stringify({ content: commentContent }),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error creating comment: ${response.statusText}`); // Handle errors appropriately
          }
          return response.json();
        })
        .then(data => {
          // Update comments section
          const commentsSection = document.getElementById('comments-section');
          commentsSection.innerHTML = data.comments_html; // Replace with your HTML update logic
          document.getElementById('comment_content').value = ''; // Clear comment input
        })
        .catch(error => {
          console.error(error); // Display error message to the user (optional)
        });
      });
</script>
{% endblock %}
